
# A secret of harbor admin password.
apiVersion: v1
kind: Secret
metadata:
  name: admin-core-secret
  namespace: cluster-sample-ns
data:
  secret: aGFyYm9yMTIzNA==
type: Opaque

---
# Cert issuer
apiVersion: cert-manager.io/v1
kind: Issuer
metadata:
  name: selfsigned-issuer
  namespace: cluster-sample-ns
spec:
  selfSigned: {}
---

apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: sample-public-certificate
  namespace: cluster-sample-ns
spec:
  isCA: true
  duration: 2160h # 90d 2160h
  renewBefore: 168h # 7d 168h
  commonName: harb6.apps.opst.divyanshutech.xyz
  dnsNames:
    - harb6.apps.opst.divyanshutech.xyz
    - notary6.apps.opst.divyanshutech.xyz
  privateKey:
    algorithm: RSA
    encoding: PKCS8
    size: 4096
  issuerRef:
    kind: Issuer
    name: selfsigned-issuer
  secretName: sample-public-certificate

---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: sample-harbor-registry
  namespace: cluster-sample-ns
spec:
  accessModes:
    - ReadWriteOnce
  volumeMode: Filesystem
  resources:
    requests:
      storage: 3Gi
---
# Full stack Harbor
apiVersion: goharbor.io/v1beta1
kind: HarborCluster
metadata:
  name: harborcluster-sample
  namespace: cluster-sample-ns
spec:
  version: 2.3.0
  logLevel: debug
  imageSource:
    repository: ghcr.io/goharbor
  harborAdminPasswordRef: admin-core-secret
  externalURL: https://harb6.apps.opst.divyanshutech.xyz
  expose:
    core:
      ingress:
        host: harb6.apps.opst.divyanshutech.xyz
        controller: default
      tls:
        certificateRef: sample-public-certificate
  internalTLS:
    enabled: false
  portal: {}
  registry:
    metrics:
      enabled: true
  core:
    tokenIssuer:
      name: selfsigned-issuer
      kind: Issuer
    metrics:
      enabled: true
  exporter: {}
  database:
    kind: PostgreSQL
    spec:
      postgresql: 
        username: postgres # Required
        passwordRef: new-psql # Optional
        hosts:
          - host: psql-postgresql.psql.svc.cluster.local
            port: 5432 # Optional  
        sslMode: require
  storage:
    kind: FileSystem
    spec:
      fileSystem:
        registryPersistentVolume:
          claimName: sample-harbor-registry
  cache:
    kind: "Redis"
    spec:
      redis:
        # Server host.
        host: harbor-redis-master.cluster-sample-ns.svc.cluster.local
        # Server port.
        port: 6379 # Required
        # For setting sentinel masterSet. 
        # Secret containing the password to use when connecting to the server.
        passwordRef: harbor-redis # Optional
        # Secret containing the client certificate to authenticate with.

