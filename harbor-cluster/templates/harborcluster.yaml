
# Full stack Harbor
apiVersion: goharbor.io/v1beta1
kind: HarborCluster
metadata:
  name: {{ .Release.Name }}

spec:
  version: {{ .Values.version }}
  logLevel: debug #info
  harborAdminPasswordRef: {{ .Release.Name }}-admin-core-secret
  externalURL: https://{{ .Values.core.hostname }}
  expose:
    core:
      ingress:
        host: {{ .Values.core.ingress.hostname }}
        controller: default
        annotations:
          kubernetes.io/ingress.class: "{{ .Values.core.ingress.class }}"
      tls:
        certificateRef: {{ .Release.Name }}-core-tls

  internalTLS:
    enabled: false
  portal: {}
  registry:
    metrics:
      enabled: true

  core:
    tokenIssuer:
      name: selfsigned-issuer
      kind: Issuer
    metrics:
      enabled: true
  exporter: {}

  # Database configuration
  # https://github.com/goharbor/harbor-operator/blob/master/docs/CRD/custom-resource-definition.md#standard-database
  
  database:
    kind: PostgreSQL
    spec:
      postgresql: 
        username: postgres # Required
        passwordRef: {{ .Values.postgresql.fullnameOverride }}
        hosts:
          - host: {{ .Values.postgresql.fullnameOverride }}
            port: 5432  
        sslMode: disable

  
  storage:
    kind: FileSystem
    spec:
      # Filesystem storage configuration
      # https://github.com/goharbor/harbor-operator/blob/master/docs/CRD/custom-resource-definition.md#filesystem
      fileSystem:
        registryPersistentVolume:
          claimName: {{ .Release.Name }}-registry


  cache:
    kind: "Redis"
    spec:
      redis:
        # Server host.
        host: {{ .Values.redis.fullnameOverride }}-master
        # Server port.
        port: 6379 # Required
        # For setting sentinel masterSet. 
        # Secret containing the password to use when connecting to the server.
        passwordRef: {{ .Values.redis.fullnameOverride }} # Optional
        # Secret containing the client certificate to authenticate with.


  trivy:
    skipUpdate: false
    storage:
      cachePersistentVolume:
        claimName: {{ .Release.Name }}-harbor-trivy-cache
      reportsPersistentVolume:
        claimName: {{ .Release.Name }}-harbor-trivy-reports